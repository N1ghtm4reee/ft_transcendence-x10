---
- name: Installing k3s in master node
  hosts: master
  become: true
  tasks:
    - name: Run the script to setup master node
      ansible.builtin.script: ../scripts/master.sh

    - name: Copy token to local file system
      ansible.builtin.fetch:
        src: /home/token.txt
        dest: ../env_files/token.txt
        flat: yes

- name: Installing k3s in agent nodes and joining master node server with token
  hosts: workers
  become: true
  vars:
    master_ip: "{{ hostvars[groups['master'][0]]['ansible_default_ipv4']['address'] }}"
  tasks:
    - name: Copy token file to the cloud machine filesystem
      ansible.builtin.copy:
        src: ../env_files/token.txt
        dest: /home/token.txt
        mode: '0644'

    - name: Copy worker.sh to the cloud machine
      ansible.builtin.copy:
        src: ../scripts/worker.sh
        dest: /home/worker.sh
        mode: '0755'

    - name: Install k3s and join nodes to server
      ansible.builtin.shell: /home/worker.sh

- name: Installing dashboard UI for cluster visualization
  hosts: master
  become: true
  tasks:
    - name: Run the dashboard script
      ansible.builtin.script: ../scripts/dashboard.sh

    - name: Fetch dashboard_token.txt to local machine
      ansible.builtin.fetch:
        src: /home/dashboard_token.txt
        dest: ../env_files/dashboard_token.txt
        flat: yes

    - name: Fetch dashboard_ip_port.txt to local machine
      ansible.builtin.fetch:
        src: /home/dashboard_ip_port.txt
        dest: ../env_files/dashboard_ip_port.txt
        flat: yes

- name: Copy manifests to cloud machine
  hosts: master
  become: true
  tasks:
    - name: Copy entire manifests directory to cloud machine
      ansible.builtin.copy:
        src: ../../k8s/manifests/
        dest: /home/manifests/
        mode: '0644'

- name: Deploy services
  hosts: master
  become: true
  tasks:
    - name: create namespace
      ansible.builtin.command: kubectl apply -f /home/manifests/app/namespace.yaml
    - name: Apply Config Map 
      ansible.builtin.command: kubectl apply -f /home/manifests/app/config-map.yaml
    - name: Apply api-gateway manifest
      ansible.builtin.command: kubectl apply -f /home/manifests/app/api-gateway.yaml
    - name: Apply chat-service manifest
      ansible.builtin.command: kubectl apply -f /home/manifests/app/chat-service.yaml
    - name: Apply auth-service manifest
      ansible.builtin.command: kubectl apply -f /home/manifests/app/auth-service.yaml