<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notification Service - Two User Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .main-content {
        display: flex;
        min-height: 600px;
      }

      .user-panel {
        flex: 1;
        padding: 20px;
        border-right: 2px solid #f0f0f0;
      }

      .user-panel:last-child {
        border-right: none;
      }

      .user-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      .user-header.user2 {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
      }

      .status-disconnected {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
      }

      .status-connected {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .message-form {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
      }

      .notifications-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .notification-item {
        background: white;
        border-left: 4px solid #667eea;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .notification-item.unread {
        border-left-color: #ff4757;
        background: #fff5f5;
      }

      .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .notification-type {
        background: #667eea;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .notification-time {
        color: #666;
        font-size: 12px;
      }

      .notification-content {
        color: #333;
        font-size: 14px;
      }

      .stats-panel {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .stat-card {
        flex: 1;
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .log-panel {
        background: #1a1a1a;
        color: #00ff00;
        padding: 15px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-error {
        color: #ff4757;
      }

      .log-success {
        color: #2ed573;
      }

      .log-info {
        color: #3742fa;
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }

        .user-panel {
          border-right: none;
          border-bottom: 2px solid #f0f0f0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîî Notification Service - Two User Test</h1>
        <p>Test real-time notifications between two users</p>
      </div>

      <div class="main-content">
        <!-- User 1 Panel -->
        <div class="user-panel">
          <div class="user-header">
            <h2>üë§ Alice (User ID: 1)</h2>
          </div>

          <div id="status1" class="connection-status status-disconnected">
            ‚ùå Disconnected
          </div>

          <div class="stats-panel">
            <div class="stat-card">
              <div class="stat-number" id="unread1">0</div>
              <div class="stat-label">Unread</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="total1">0</div>
              <div class="stat-label">Total</div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" onclick="connectUser(1)">Connect</button>
            <button class="btn btn-secondary" onclick="disconnectUser(1)">
              Disconnect
            </button>
            <button class="btn btn-secondary" onclick="loadNotifications(1)">
              Refresh
            </button>
            <button class="btn btn-secondary" onclick="markAllRead(1)">
              Mark All Read
            </button>
            <button class="btn btn-secondary" onclick="checkUserOnline(2)">
              Check Bob's Status
            </button>
          </div>

          <div class="message-form">
            <h3>üì® Send Message to Bob</h3>
            <div class="form-group">
              <label>Message Type:</label>
              <select id="type1">
                <option value="message">Message</option>
                <option value="friend_request">Friend Request</option>
                <option value="game_invite">Game Invite</option>
                <option value="system">System Alert</option>
              </select>
            </div>
            <div class="form-group">
              <label>Title:</label>
              <input
                type="text"
                id="title1"
                placeholder="Enter message title"
              />
            </div>
            <div class="form-group">
              <label>Message:</label>
              <textarea
                id="message1"
                placeholder="Enter your message"
              ></textarea>
            </div>
            <button class="btn" onclick="sendMessage(1, 2)">Send to Bob</button>
          </div>

          <div class="notifications-panel">
            <h3>üìã Alice's Notifications</h3>
            <div id="notifications1"></div>
          </div>
        </div>

        <!-- User 2 Panel -->
        <div class="user-panel">
          <div class="user-header user2">
            <h2>üë§ Bob (User ID: 2)</h2>
          </div>

          <div id="status2" class="connection-status status-disconnected">
            ‚ùå Disconnected
          </div>

          <div class="stats-panel">
            <div class="stat-card">
              <div class="stat-number" id="unread2">0</div>
              <div class="stat-label">Unread</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="total2">0</div>
              <div class="stat-label">Total</div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" onclick="connectUser(2)">Connect</button>
            <button class="btn btn-secondary" onclick="disconnectUser(2)">
              Disconnect
            </button>
            <button class="btn btn-secondary" onclick="loadNotifications(2)">
              Refresh
            </button>
            <button class="btn btn-secondary" onclick="markAllRead(2)">
              Mark All Read
            </button>
            <button class="btn btn-secondary" onclick="checkUserOnline(1)">
              Check Alice's Status
            </button>
          </div>

          <div class="message-form">
            <h3>üì® Send Message to Alice</h3>
            <div class="form-group">
              <label>Message Type:</label>
              <select id="type2">
                <option value="message">Message</option>
                <option value="friend_request">Friend Request</option>
                <option value="game_invite">Game Invite</option>
                <option value="system">System Alert</option>
              </select>
            </div>
            <div class="form-group">
              <label>Title:</label>
              <input
                type="text"
                id="title2"
                placeholder="Enter message title"
              />
            </div>
            <div class="form-group">
              <label>Message:</label>
              <textarea
                id="message2"
                placeholder="Enter your message"
              ></textarea>
            </div>
            <button class="btn" onclick="sendMessage(2, 1)">
              Send to Alice
            </button>
          </div>

          <div class="notifications-panel">
            <h3>üìã Bob's Notifications</h3>
            <div id="notifications2"></div>
          </div>
        </div>
      </div>

      <div style="text-align: center; padding: 20px">
        <button class="btn" onclick="getAllOnlineUsers()">
          üìä Check All Online Users
        </button>
      </div>

      <div class="log-panel">
        <h3>üìä System Log</h3>
        <div id="log"></div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3005/api/notifications";
      const WS_BASE = "ws://localhost:3005/ws/notifications";

      let websockets = {};
      let notificationCounts = {
        1: { unread: 0, total: 0 },
        2: { unread: 0, total: 0 },
      };

      // Logging function
      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      // Connect user to WebSocket
      function connectUser(userId) {
        if (websockets[userId]) {
          log(`User ${userId} already connected`, "info");
          return;
        }

        try {
          const ws = new WebSocket(`${WS_BASE}/live?userId=${userId}`);

          ws.onopen = () => {
            log(`User ${userId} connected to WebSocket`, "success");
            updateConnectionStatus(userId, true);
            loadNotifications(userId);
            loadUnreadCount(userId);
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              log(`User ${userId} received: ${JSON.stringify(data)}`, "info");

              if (data.type === "notification") {
                handleIncomingNotification(userId, data.data);
              } else if (data.type === "notification_read") {
                handleNotificationRead(userId, data);
              } else if (data.type === "all_notifications_read") {
                handleAllNotificationsRead(userId, data);
              }
            } catch (error) {
              log(
                `Error parsing WebSocket message for user ${userId}: ${error.message}`,
                "error"
              );
            }
          };

          ws.onclose = () => {
            log(`User ${userId} WebSocket connection closed`, "info");
            updateConnectionStatus(userId, false);
            delete websockets[userId];
          };

          ws.onerror = (error) => {
            log(`WebSocket error for user ${userId}: ${error}`, "error");
            updateConnectionStatus(userId, false);
          };

          websockets[userId] = ws;
        } catch (error) {
          log(`Failed to connect user ${userId}: ${error.message}`, "error");
        }
      }

      // Disconnect user
      function disconnectUser(userId) {
        if (websockets[userId]) {
          websockets[userId].close();
          delete websockets[userId];
          updateConnectionStatus(userId, false);
          log(`User ${userId} disconnected`, "info");
        }
      }

      // Update connection status UI
      function updateConnectionStatus(userId, connected) {
        const statusEl = document.getElementById(`status${userId}`);
        if (connected) {
          statusEl.textContent = "‚úÖ Connected";
          statusEl.className = "connection-status status-connected";
        } else {
          statusEl.textContent = "‚ùå Disconnected";
          statusEl.className = "connection-status status-disconnected";
        }
      }

      // Send message between users
      async function sendMessage(fromUserId, toUserId) {
        const type = document.getElementById(`type${fromUserId}`).value;
        const title = document.getElementById(`title${fromUserId}`).value;
        const message = document.getElementById(`message${fromUserId}`).value;

        if (!title || !message) {
          log(`Please fill in all fields for user ${fromUserId}`, "error");
          return;
        }

        const notificationData = {
          userId: toUserId,
          type: type,
          title: title,
          content: message,
          sourceId: `msg_${Date.now()}`,
          sourceType: "user_message",
        };

        try {
          const response = await fetch(API_BASE + "/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(notificationData),
          });

          if (response.ok) {
            const result = await response.json();
            log(
              `Message sent from user ${fromUserId} to user ${toUserId}: ${title}`,
              "success"
            );

            // Clear form
            document.getElementById(`title${fromUserId}`).value = "";
            document.getElementById(`message${fromUserId}`).value = "";

            // Refresh both users' notifications
            setTimeout(() => {
              loadNotifications(toUserId);
              loadUnreadCount(toUserId);
            }, 500);
          } else {
            const error = await response.json();
            log(`Failed to send message: ${error.error}`, "error");
          }
        } catch (error) {
          log(`Error sending message: ${error.message}`, "error");
        }
      }

      // Load notifications for user
      async function loadNotifications(userId) {
        try {
          const response = await fetch(API_BASE + "/", {
            headers: {
              "x-user-id": userId.toString(),
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayNotifications(userId, data.notifications);
            notificationCounts[userId].total = data.pagination.total;
            updateNotificationCounts(userId);
            log(
              `Loaded ${data.notifications.length} notifications for user ${userId}`,
              "success"
            );
          } else {
            log(`Failed to load notifications for user ${userId}`, "error");
          }
        } catch (error) {
          log(
            `Error loading notifications for user ${userId}: ${error.message}`,
            "error"
          );
        }
      }

      // Load unread count
      async function loadUnreadCount(userId) {
        try {
          const response = await fetch(API_BASE + "/unread-count", {
            headers: {
              "x-user-id": userId.toString(),
            },
          });

          if (response.ok) {
            const data = await response.json();
            notificationCounts[userId].unread = data.count;
            updateNotificationCounts(userId);
          } else {
            log(`Failed to load unread count for user ${userId}`, "error");
          }
        } catch (error) {
          log(
            `Error loading unread count for user ${userId}: ${error.message}`,
            "error"
          );
        }
      }

      // Display notifications in UI
      function displayNotifications(userId, notifications) {
        const container = document.getElementById(`notifications${userId}`);
        container.innerHTML = "";

        if (notifications.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666; padding: 20px;">No notifications yet</p>';
          return;
        }

        notifications.forEach((notification) => {
          const notifEl = document.createElement("div");
          notifEl.className = `notification-item ${
            !notification.read ? "unread" : ""
          }`;
          notifEl.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-type">${
                          notification.type
                        }</span>
                        <span class="notification-time">${new Date(
                          notification.createdAt
                        ).toLocaleTimeString()}</span>
                    </div>
                    <div class="notification-content">
                        <strong>${notification.title}</strong><br>
                        ${notification.content}
                    </div>
                    ${
                      !notification.read
                        ? `<button class="btn btn-secondary" style="margin-top: 8px; padding: 5px 10px; font-size: 12px;" onclick="markAsRead(${userId}, '${notification.id}')">Mark as Read</button>`
                        : ""
                    }
                `;
          container.appendChild(notifEl);
        });
      }

      // Update notification counts in UI
      function updateNotificationCounts(userId) {
        document.getElementById(`unread${userId}`).textContent =
          notificationCounts[userId].unread;
        document.getElementById(`total${userId}`).textContent =
          notificationCounts[userId].total;
      }

      // Mark single notification as read
      async function markAsRead(userId, notificationId) {
        try {
          const response = await fetch(API_BASE + `/${notificationId}/read`, {
            method: "PATCH",
            headers: {
              "x-user-id": userId.toString(),
            },
          });

          if (response.ok) {
            log(
              `Notification ${notificationId} marked as read for user ${userId}`,
              "success"
            );
            loadNotifications(userId);
            loadUnreadCount(userId);
          } else {
            log(
              `Failed to mark notification as read for user ${userId}`,
              "error"
            );
          }
        } catch (error) {
          log(`Error marking notification as read: ${error.message}`, "error");
        }
      }

      // Mark all notifications as read
      async function markAllRead(userId) {
        try {
          const response = await fetch(API_BASE + "/read-all", {
            method: "PATCH",
            headers: {
              "x-user-id": userId.toString(),
            },
          });

          if (response.ok) {
            const data = await response.json();
            log(
              `All notifications marked as read for user ${userId} (${data.updatedCount} updated)`,
              "success"
            );
            loadNotifications(userId);
            loadUnreadCount(userId);
          } else {
            log(
              `Failed to mark all notifications as read for user ${userId}`,
              "error"
            );
          }
        } catch (error) {
          log(
            `Error marking all notifications as read: ${error.message}`,
            "error"
          );
        }
      }

      // Check if a user is online
      async function checkUserOnline(userId) {
        try {
          const response = await fetch(API_BASE + `/user/${userId}/online`);

          if (response.ok) {
            const data = await response.json();
            log(
              `üë§ User ${userId} status: ${
                data.online ? "‚úÖ Online" : "‚ùå Offline"
              } (${data.connections} connection(s))`,
              data.online ? "success" : "info"
            );
          } else {
            log(`Failed to check online status for user ${userId}`, "error");
          }
        } catch (error) {
          log(
            `Error checking online status for user ${userId}: ${error.message}`,
            "error"
          );
        }
      }

      // Get all online users
      async function getAllOnlineUsers() {
        try {
          const response = await fetch(API_BASE + "/users/online");

          if (response.ok) {
            const data = await response.json();
            log(`üë• Total online users: ${data.totalOnline}`, "success");

            if (data.onlineUsers.length > 0) {
              data.onlineUsers.forEach((user) => {
                log(
                  `   - User ${user.userId}: ${user.connections} connection(s)`,
                  "info"
                );
              });
            }
          } else {
            log("Failed to get online users", "error");
          }
        } catch (error) {
          log(`Error getting online users: ${error.message}`, "error");
        }
      }

      // Handle incoming real-time notification
      function handleIncomingNotification(userId, notification) {
        log(
          `üì® Real-time notification received for user ${userId}: ${notification.title}`,
          "success"
        );

        // Add visual notification
        showToast(userId, notification);

        // Update counts and reload notifications
        setTimeout(() => {
          loadNotifications(userId);
          loadUnreadCount(userId);
        }, 100);
      }

      // Handle notification read event
      function handleNotificationRead(userId, data) {
        log(`üìñ Notification marked as read for user ${userId}`, "info");
        loadNotifications(userId);
        loadUnreadCount(userId);
      }

      // Handle all notifications read event
      function handleAllNotificationsRead(userId, data) {
        log(
          `üìñ All notifications marked as read for user ${userId} (${data.updatedCount} updated)`,
          "info"
        );
        loadNotifications(userId);
        loadUnreadCount(userId);
      }

      // Show toast notification
      function showToast(userId, notification) {
        // Create toast element
        const toast = document.createElement("div");
        toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;

        toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">üîî New Notification for User ${userId}</div>
                <div style="font-size: 14px;">${notification.title}</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${notification.content}</div>
            `;

        // Add animation
        const style = document.createElement("style");
        style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
        document.head.appendChild(style);

        document.body.appendChild(toast);

        // Remove after 4 seconds
        setTimeout(() => {
          toast.remove();
          style.remove();
        }, 4000);
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", () => {
        log("Notification Test UI initialized", "success");
        log('Click "Connect" buttons to start WebSocket connections', "info");

        // Pre-fill some example messages
        document.getElementById("title1").value = "Hello Bob!";
        document.getElementById("message1").value =
          "Hey there! How are you doing?";
        document.getElementById("title2").value = "Hi Alice!";
        document.getElementById("message2").value =
          "I'm doing great! Thanks for asking!";
      });

      // Auto-connect both users after 2 seconds for demo
      setTimeout(() => {
        log("Auto-connecting both users for demo...", "info");
        connectUser(1);
        connectUser(2);
      }, 2000);
    </script>
  </body>
</html>
